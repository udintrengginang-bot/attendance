import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyArMFpT8YIkJhMGIEPTghKMCTTQsbAwK3I",
    authDomain: "dad-attendance.firebaseapp.com",
    projectId: "dad-attendance",
    storageBucket: "dad-attendance.firebasestorage.app",
    messagingSenderId: "626292583397",
    appId: "1:626292583397:web:b0078d3a49840f38631d0c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

// Translations
const translations = {
    en: {
        worker_checkin: "Worker Portal", mobile_label: "Mobile Number", pin_label: "4-Digit PIN",
        placeholder_mobile: "Enter 10-digit number", placeholder_pin: "Enter 4-digit PIN",
        login: "Login", need_help: "Need help?", call_ajit: "Call Ajit", whatsapp: "WhatsApp",
        welcome: "Welcome", todays_task: "Today's Task", from_ajit: "From Ajit",
        select_site: "ЁЯУН Where are you today?", start_work: "START WORK",
        working_at: "Working today at", working_time: "тП▒я╕П Working", hours_minutes: "hours : minutes",
        todays_earnings: "ЁЯТ░ Today's Earnings", hourly_rate: "Hourly Rate", per_hour: "/hr",
        pay_disclaimer: "* Pay can be modified. Contact Ajit for details.",
        upload_photo: "Upload Work Photo", end_work: "END WORK", work_history: "Last 7 Days",
        upload_work_photo: "ЁЯУ╖ Upload Today's Work Photo", photo_tips: "тЬи Tips for good photos:",
        tip_1: "тАв Show what you completed today", tip_2: "тАв Take clear, well-lit photos",
        tip_3: "тАв Include the work area", take_photo: "Take Photo", gallery: "Gallery",
        work_description: "ЁЯУЭ What did you work on?",
        placeholder_description: "Example: Completed wall plastering in Room 2",
        cancel: "Cancel", upload: "Upload Photo", end_work_confirm: "тЪая╕П End Your Work Day?",
        worked_at: "You worked at:", total_time: "тП▒я╕П Total time:", earnings: "ЁЯТ░ Earnings:",
        pay_final_disclaimer: "* Final pay confirmed by Ajit at month-end",
        keep_working: "No, Keep Working", yes_end_work: "Yes, End Work",
        work_ended: "Work Day Ended!", you_worked: "You worked:", you_earned: "You earned:",
        site: "Site:", see_you_tomorrow: "See you tomorrow! ЁЯСЛ", close: "Close", logout: "Logout",
        no_sites: "No sites assigned", contact_ajit: "Contact Ajit to assign sites",
        invalid_login: "Invalid mobile number or PIN", error_occurred: "An error occurred. Please try again.",
        photo_uploaded: "Photo uploaded successfully!", uploading: "Uploading...",
        error_upload: "Error uploading photo", select_photo_first: "Please select a photo first",
        work_started: "Work started successfully!", work_ended_success: "Work ended successfully!",
        error_start: "Error starting work", error_end: "Error ending work"
    },
    hi: {
        worker_checkin: "рдХрд╛рдордЧрд╛рд░ рдкреЛрд░реНрдЯрд▓", mobile_label: "рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░", pin_label: "4-рдЕрдВрдХреАрдп рдкрд┐рди",
        placeholder_mobile: "10-рдЕрдВрдХреАрдп рдирдВрдмрд░ рджрд░реНрдЬ рдХрд░реЗрдВ", placeholder_pin: "4-рдЕрдВрдХреАрдп рдкрд┐рди рджрд░реНрдЬ рдХрд░реЗрдВ",
        login: "рд▓реЙрдЧ рдЗрди рдХрд░реЗрдВ", need_help: "рдорджрдж рдЪрд╛рд╣рд┐рдП?", call_ajit: "рдЕрдЬрд┐рдд рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВ", whatsapp: "рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк",
        welcome: "рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ", todays_task: "рдЖрдЬ рдХрд╛ рдХрд╛рд░реНрдп", from_ajit: "рдЕрдЬрд┐рдд рдХреА рдУрд░ рд╕реЗ",
        select_site: "ЁЯУН рдЖрдЬ рдЖрдк рдХрд╣рд╛рдБ рд╣реИрдВ?", start_work: "рдХрд╛рдо рд╢реБрд░реВ рдХрд░реЗрдВ",
        working_at: "рдЖрдЬ рдХрд╛рдо рдХрд░ рд░рд╣реЗ рд╣реИрдВ", working_time: "тП▒я╕П рдХрд╛рдо рдХрд░ рд░рд╣реЗ рд╣реИрдВ", hours_minutes: "рдШрдВрдЯреЗ : рдорд┐рдирдЯ",
        todays_earnings: "ЁЯТ░ рдЖрдЬ рдХреА рдХрдорд╛рдИ", hourly_rate: "рдкреНрд░рддрд┐ рдШрдВрдЯрд╛ рджрд░", per_hour: "/рдШрдВрдЯрд╛",
        pay_disclaimer: "* рд╡реЗрддрди рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП рдЕрдЬрд┐рдд рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВред",
        upload_photo: "рдХрд╛рдо рдХреА рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ", end_work: "рдХрд╛рдо рд╕рдорд╛рдкреНрдд рдХрд░реЗрдВ", work_history: "рдкрд┐рдЫрд▓реЗ 7 рджрд┐рди",
        upload_work_photo: "ЁЯУ╖ рдЖрдЬ рдХреЗ рдХрд╛рдо рдХреА рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ", photo_tips: "тЬи рдЕрдЪреНрдЫреА рдлреЛрдЯреЛ рдХреЗ рд▓рд┐рдП рд╕реБрдЭрд╛рд╡:",
        tip_1: "тАв рдЖрдЬ рдХреНрдпрд╛ рдкреВрд░рд╛ рдХрд┐рдпрд╛ рджрд┐рдЦрд╛рдПрдВ", tip_2: "тАв рд╕реНрдкрд╖реНрдЯ, рдЕрдЪреНрдЫреА рд░реЛрд╢рдиреА рдореЗрдВ рдлреЛрдЯреЛ рд▓реЗрдВ",
        tip_3: "тАв рдХрд╛рдо рдХреЗ рдХреНрд╖реЗрддреНрд░ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ", take_photo: "рдлреЛрдЯреЛ рд▓реЗрдВ", gallery: "рдЧреИрд▓рд░реА",
        work_description: "ЁЯУЭ рдЖрдкрдиреЗ рдХреНрдпрд╛ рдХрд╛рдо рдХрд┐рдпрд╛?",
        placeholder_description: "рдЙрджрд╛рд╣рд░рдг: рдХрдорд░рд╛ 2 рдореЗрдВ рджреАрд╡рд╛рд░ рдХрд╛ рдкреНрд▓рд╛рд╕реНрдЯрд░ рдкреВрд░рд╛ рдХрд┐рдпрд╛",
        cancel: "рд░рджреНрдж рдХрд░реЗрдВ", upload: "рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ", end_work_confirm: "тЪая╕П рдХрд╛рдо рдХрд╛ рджрд┐рди рд╕рдорд╛рдкреНрдд рдХрд░реЗрдВ?",
        worked_at: "рдЖрдкрдиреЗ рдХрд╛рдо рдХрд┐рдпрд╛:", total_time: "тП▒я╕П рдХреБрд▓ рд╕рдордп:", earnings: "ЁЯТ░ рдХрдорд╛рдИ:",
        pay_final_disclaimer: "* рдЕрдВрддрд┐рдо рд╡реЗрддрди рдорд╣реАрдиреЗ рдХреЗ рдЕрдВрдд рдореЗрдВ рдЕрдЬрд┐рдд рджреНрд╡рд╛рд░рд╛ рдкреБрд╖реНрдЯрд┐ рдХреА рдЬрд╛рдПрдЧреА",
        keep_working: "рдирд╣реАрдВ, рдХрд╛рдо рдЬрд╛рд░реА рд░рдЦреЗрдВ", yes_end_work: "рд╣рд╛рдБ, рдХрд╛рдо рд╕рдорд╛рдкреНрдд рдХрд░реЗрдВ",
        work_ended: "рдХрд╛рдо рдХрд╛ рджрд┐рди рд╕рдорд╛рдкреНрдд!", you_worked: "рдЖрдкрдиреЗ рдХрд╛рдо рдХрд┐рдпрд╛:", you_earned: "рдЖрдкрдиреЗ рдХрдорд╛рдпрд╛:",
        site: "рд╕рд╛рдЗрдЯ:", see_you_tomorrow: "рдХрд▓ рдорд┐рд▓реЗрдВрдЧреЗ! ЁЯСЛ", close: "рдмрдВрдж рдХрд░реЗрдВ", logout: "рд▓реЙрдЧ рдЖрдЙрдЯ",
        no_sites: "рдХреЛрдИ рд╕рд╛рдЗрдЯ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдирд╣реАрдВ", contact_ajit: "рд╕рд╛рдЗрдЯ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдЬрд┐рдд рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВ",
        invalid_login: "рдЧрд▓рдд рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рдпрд╛ рдкрд┐рди", error_occurred: "рдПрдХ рддреНрд░реБрдЯрд┐ рд╣реБрдИред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред",
        photo_uploaded: "рдлреЛрдЯреЛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрд▓реЛрдб!", uploading: "рдЕрдкрд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...",
        error_upload: "рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐", select_photo_first: "рдХреГрдкрдпрд╛ рдкрд╣рд▓реЗ рдПрдХ рдлреЛрдЯреЛ рдЪреБрдиреЗрдВ",
        work_started: "рдХрд╛рдо рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╢реБрд░реВ!", work_ended_success: "рдХрд╛рдо рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕рдорд╛рдкреНрдд!",
        error_start: "рдХрд╛рдо рд╢реБрд░реВ рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐", error_end: "рдХрд╛рдо рд╕рдорд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐"
    },
    mr: {
        worker_checkin: "рдХрд╛рдордЧрд╛рд░ рдкреЛрд░реНрдЯрд▓", mobile_label: "рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░", pin_label: "4-рдЕрдВрдХреА рдкрд┐рди",
        placeholder_mobile: "10-рдЕрдВрдХреА рдирдВрдмрд░ рдЯрд╛рдХрд╛", placeholder_pin: "4-рдЕрдВрдХреА рдкрд┐рди рдЯрд╛рдХрд╛",
        login: "рд▓реЙрдЧ рдЗрди рдХрд░рд╛", need_help: "рдорджрдд рд╣рд╡реА рдЖрд╣реЗ?", call_ajit: "рдЕрдЬрд┐рдд рд▓рд╛ рдХреЙрд▓ рдХрд░рд╛", whatsapp: "рд╡реНрд╣рд╛рдЯреНрд╕рдЕреЕрдк",
        welcome: "рдЖрдкрд▓реЗ рд╕реНрд╡рд╛рдЧрдд рдЖрд╣реЗ", todays_task: "рдЖрдЬрдЪреЗ рдХрд╛рд░реНрдп", from_ajit: "рдЕрдЬрд┐рдд рдХрдбреВрди",
        select_site: "ЁЯУН рдЖрдЬ рддреБрдореНрд╣реА рдХреБрдареЗ рдЖрд╣рд╛рдд?", start_work: "рдХрд╛рдо рд╕реБрд░реВ рдХрд░рд╛",
        working_at: "рдЖрдЬ рдХрд╛рдо рдХрд░рдд рдЖрд╣рд╛рдд", working_time: "тП▒я╕П рдХрд╛рдо рдХрд░рдд рдЖрд╣рд╛рдд", hours_minutes: "рддрд╛рд╕ : рдорд┐рдирд┐рдЯреЗ",
        todays_earnings: "ЁЯТ░ рдЖрдЬрдЪреА рдХрдорд╛рдИ", hourly_rate: "рддрд╛рд╕рд╛рдЪреА рджрд░", per_hour: "/рддрд╛рд╕",
        pay_disclaimer: "* рд╡реЗрддрди рд╕реБрдзрд╛рд░рд▓реЗ рдЬрд╛рдК рд╢рдХрддреЗред рддрдкрд╢реАрд▓рд╛рд╕рд╛рдареА рдЕрдЬрд┐рдд рд▓рд╛ рд╕рдВрдкрд░реНрдХ рдХрд░рд╛ред",
        upload_photo: "рдХрд╛рдорд╛рдЪрд╛ рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░рд╛", end_work: "рдХрд╛рдо рд╕рдВрдкрд╡рд╛", work_history: "рдЧреЗрд▓реЗ 7 рджрд┐рд╡рд╕",
        upload_work_photo: "ЁЯУ╖ рдЖрдЬрдЪреНрдпрд╛ рдХрд╛рдорд╛рдЪрд╛ рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░рд╛", photo_tips: "тЬи рдЪрд╛рдВрдЧрд▓реНрдпрд╛ рдлреЛрдЯреЛрд╕рд╛рдареА рдЯрд┐рдкреНрд╕:",
        tip_1: "тАв рдЖрдЬ рдХрд╛рдп рдкреВрд░реНрдг рдХреЗрд▓реЗ рддреЗ рджрд╛рдЦрд╡рд╛", tip_2: "тАв рд╕реНрдкрд╖реНрдЯ, рдЪрд╛рдВрдЧрд▓реНрдпрд╛ рдкреНрд░рдХрд╛рд╢рд╛рдд рдлреЛрдЯреЛ рдШреНрдпрд╛",
        tip_3: "тАв рдХрд╛рдорд╛рдЪреЗ рдХреНрд╖реЗрддреНрд░ рд╕рдорд╛рд╡рд┐рд╖реНрдЯ рдХрд░рд╛", take_photo: "рдлреЛрдЯреЛ рдШреНрдпрд╛", gallery: "рдЧреЕрд▓рд░реА",
        work_description: "ЁЯУЭ рддреБрдореНрд╣реА рдХрд╛рдп рдХрд╛рдо рдХреЗрд▓реЗрдд?",
        placeholder_description: "рдЙрджрд╛рд╣рд░рдг: рдЦреЛрд▓реА 2 рдордзреНрдпреЗ рднрд┐рдВрдд рдкреНрд▓рд╛рд╕реНрдЯрд░ рдкреВрд░реНрдг рдХреЗрд▓реЗ",
        cancel: "рд░рджреНрдж рдХрд░рд╛", upload: "рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░рд╛", end_work_confirm: "тЪая╕П рдХрд╛рдорд╛рдЪрд╛ рджрд┐рд╡рд╕ рд╕рдВрдкрд╡рд╛рдпрдЪрд╛?",
        worked_at: "рддреБрдореНрд╣реА рдХрд╛рдо рдХреЗрд▓реЗрдд:", total_time: "тП▒я╕П рдПрдХреВрдг рд╡реЗрд│:", earnings: "ЁЯТ░ рдХрдорд╛рдИ:",
        pay_final_disclaimer: "* рдЕрдВрддрд┐рдо рд╡реЗрддрди рдорд╣рд┐рдиреНрдпрд╛рдЪреНрдпрд╛ рд╢реЗрд╡рдЯреА рдЕрдЬрд┐рдд рджреНрд╡рд╛рд░реЗ рдкреБрд╖реНрдЯреА рдХреЗрд▓реА рдЬрд╛рдИрд▓",
        keep_working: "рдирд╛рд╣реА, рдХрд╛рдо рдЪрд╛рд▓реВ рдареЗрд╡рд╛", yes_end_work: "рд╣реЛрдп, рдХрд╛рдо рд╕рдВрдкрд╡рд╛",
        work_ended: "рдХрд╛рдорд╛рдЪрд╛ рджрд┐рд╡рд╕ рд╕рдВрдкрд▓рд╛!", you_worked: "рддреБрдореНрд╣реА рдХрд╛рдо рдХреЗрд▓реЗрдд:", you_earned: "рддреБрдореНрд╣реА рдХрдорд╛рд╡рд▓реЗрдд:",
        site: "рд╕рд╛рдЗрдЯ:", see_you_tomorrow: "рдЙрджреНрдпрд╛ рднреЗрдЯреВ! ЁЯСЛ", close: "рдмрдВрдж рдХрд░рд╛", logout: "рд▓реЙрдЧ рдЖрдЙрдЯ",
        no_sites: "рдХреЛрдгрддреАрд╣реА рд╕рд╛рдЗрдЯ рдирд┐рдпреБрдХреНрдд рдирд╛рд╣реА", contact_ajit: "рд╕рд╛рдЗрдЯ рдирд┐рдпреБрдХреНрдд рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдЕрдЬрд┐рдд рд▓рд╛ рд╕рдВрдкрд░реНрдХ рдХрд░рд╛",
        invalid_login: "рдЪреБрдХреАрдЪрд╛ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рдХрд┐рдВрд╡рд╛ рдкрд┐рди", error_occurred: "рдПрдХ рддреНрд░реБрдЯреА рдЭрд╛рд▓реА. рдХреГрдкрдпрд╛ рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛.",
        photo_uploaded: "рдлреЛрдЯреЛ рдпрд╢рд╕реНрд╡реАрд░рд┐рддреНрдпрд╛ рдЕрдкрд▓реЛрдб!", uploading: "рдЕрдкрд▓реЛрдб рдХрд░рдд рдЖрд╣реЗ...",
        error_upload: "рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░рддрд╛рдирд╛ рддреНрд░реБрдЯреА", select_photo_first: "рдХреГрдкрдпрд╛ рдкреНрд░рдердо рдлреЛрдЯреЛ рдирд┐рд╡рдбрд╛",
        work_started: "рдХрд╛рдо рдпрд╢рд╕реНрд╡реАрд░рд┐рддреНрдпрд╛ рд╕реБрд░реВ!", work_ended_success: "рдХрд╛рдо рдпрд╢рд╕реНрд╡реАрд░рд┐рддреНрдпрд╛ рд╕рдВрдкрд▓реЗ!",
        error_start: "рдХрд╛рдо рд╕реБрд░реВ рдХрд░рддрд╛рдирд╛ рддреНрд░реБрдЯреА", error_end: "рдХрд╛рдо рд╕рдВрдкрд╡рддрд╛рдирд╛ рддреНрд░реБрдЯреА"
    }
};

let currentLanguage = localStorage.getItem('shreeved-lang-worker') || 'en';
let currentWorker = null;
let sitesData = [];
let workStartTime = null;
let timerInterval = null;
let selectedPhoto = null;
let photosTodayCount = 0;

// Encouragement messages
const encouragementMessages = [
    "ЁЯМЯ Excellent work today!",
    "ЁЯТк Keep up the great work!",
    "ЁЯСП Another productive day!",
    "ЁЯОп Well done!",
    "тЬи Outstanding effort!",
    "ЁЯПЖ You're doing amazing!"
];

// Set Language
function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('shreeved-lang-worker', lang);
    document.querySelectorAll('[data-translate-key]').forEach(el => {
        const key = el.dataset.translateKey;
        const translation = translations[lang]?.[key] || translations['en'][key];
        if (el.placeholder) {
            el.placeholder = translation;
        } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            // Don't change value, only placeholder
        } else {
            el.textContent = translation;
        }
    });
    document.querySelectorAll('.lang-btn, .lang-btn-dash').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });
}

// Format time as HH:MM
function formatTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = Math.floor(minutes % 60);
    return `${hours}:${mins.toString().padStart(2, '0')}`;
}

// Calculate earnings
function calculateEarnings(minutes, hourlyRate) {
    const hours = minutes / 60;
    return Math.round(hours * hourlyRate);
}

// Compress image
async function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Max dimensions
                const maxWidth = 1200;
                const maxHeight = 1200;
                
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                    resolve(new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    }));
                }, 'image/jpeg', 0.7); // 70% quality
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// Create attendance log
async function createLog(action, siteId) {
    if (!currentWorker || !siteId) {
        console.error("Cannot create log: Missing worker or siteId");
        return;
    }
    try {
        await addDoc(collection(db, "attendance_logs"), {
            laborerId: currentWorker.id,
            laborerName: currentWorker.name,
            action: action,
            siteId: siteId,
            timestamp: serverTimestamp()
        });
        
        // Request notification permission and send notification
        if ('Notification' in window && Notification.permission === 'granted') {
            const siteName = sitesData.find(s => s.id === siteId)?.name || 'Unknown Site';
            const time = new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            new Notification('Shreeved', {
                body: `${currentWorker.name} ${action.toLowerCase()} at ${siteName} (${time})`,
                icon: '/icons/icon-192x192.png'
            });
        }
    } catch (error) {
        console.error("Error creating attendance log:", error);
    }
}

// Update timer
function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(() => {
        if (!workStartTime) return;
        
        const now = new Date();
        const minutesWorked = (now - workStartTime) / (1000 * 60);
        
        document.getElementById('timer-display').textContent = formatTime(minutesWorked);
        
        const earnings = calculateEarnings(minutesWorked, currentWorker.hourlyRate || 0);
        document.getElementById('earnings-display').textContent = `тВ╣${earnings}`;
    }, 1000);
}

// Stop timer
function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// Load 7-day history
async function load7DayHistory() {
    if (!currentWorker) return;
    
    const historyList = document.getElementById('history-list');
    const historyCard = document.getElementById('work-history-card');
    
    try {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        
        const logsQuery = query(
            collection(db, 'attendance_logs'),
            where('laborerId', '==', currentWorker.id),
            where('timestamp', '>=', sevenDaysAgo),
            orderBy('timestamp', 'desc')
        );
        
        const logsSnapshot = await getDocs(logsQuery);
        const logs = logsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Group by date
        const logsByDate = {};
        logs.forEach(log => {
            const date = log.timestamp.toDate().toLocaleDateString('en-IN');
            if (!logsByDate[date]) logsByDate[date] = [];
            logsByDate[date].push(log);
        });
        
        // Calculate hours per day
        const dailyStats = [];
        Object.entries(logsByDate).forEach(([date, dayLogs]) => {
            let totalMinutes = 0;
            let currentStart = null;
            
            dayLogs.sort((a, b) => a.timestamp.seconds - b.timestamp.seconds);
            
            dayLogs.forEach(log => {
                if (log.action === 'Work Started') {
                    currentStart = log.timestamp.toDate();
                } else if (log.action === 'Work Ended' && currentStart) {
                    const end = log.timestamp.toDate();
                    totalMinutes += (end - currentStart) / (1000 * 60);
                    currentStart = null;
                }
            });
            
            const earnings = calculateEarnings(totalMinutes, currentWorker.hourlyRate || 0);
            const siteName = dayLogs[0] ? sitesData.find(s => s.id === dayLogs[0].siteId)?.name : 'Unknown';
            
            dailyStats.push({ date, hours: formatTime(totalMinutes), earnings, site: siteName });
        });
        
        if (dailyStats.length === 0) {
            historyList.innerHTML = '<p class="text-slate-500 text-center">No work history yet</p>';
        } else {
            historyList.innerHTML = dailyStats.map(day => `
                <div class="border-l-4 border-green-500 pl-4 py-2">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-slate-800 text-dark">${day.date}</p>
                            <p class="text-sm text-slate-600 text-dark">ЁЯУН ${day.site}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-slate-800 text-dark">тП▒я╕П ${day.hours}</p>
                            <p class="text-sm text-green-600">тВ╣${day.earnings}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            historyCard.classList.remove('hidden');
        }
    } catch (error) {
        console.error("Error loading history:", error);
    }
}

// Show/hide UI elements
function updateUI(isWorking) {
    document.getElementById('site-selection-view').classList.toggle('hidden', isWorking);
    document.getElementById('working-status-card').classList.toggle('hidden', !isWorking);
    document.getElementById('start-work-btn').classList.toggle('hidden', isWorking);
    document.getElementById('upload-photo-btn').classList.toggle('hidden', !isWorking);
    document.getElementById('end-work-btn').classList.toggle('hidden', !isWorking);
}

// Show dashboard
function showDashboard(worker) {
    currentWorker = worker;
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('dashboard-view').classList.remove('hidden');
    
    const t = translations[currentLanguage];
    document.getElementById('worker-name').textContent = `${t.welcome}, ${worker.name}`;
    
    // Load today's task
    loadTodayTask();
    
    // Display hourly rate
    document.getElementById('hourly-rate-display').textContent = `тВ╣${worker.hourlyRate || 0}`;
    
    // Check if already working
    if (worker.status === 'Work Started' && worker.currentSiteId) {
        const site = sitesData.find(s => s.id === worker.currentSiteId);
        if (site) {
            document.getElementById('current-site-name').querySelector('span:last-child').textContent = site.name;
            workStartTime = new Date(); // Approximate - should ideally fetch from last log
            updateUI(true);
            startTimer();
        }
    } else {
        updateUI(false);
        loadSites();
    }
    
    load7DayHistory();
    
    // Request notification permission
    setTimeout(() => {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }, 2000);
}

// Load today's task
async function loadTodayTask() {
    if (!currentWorker) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    try {
        const taskQuery = query(
            collection(db, 'daily_tasks'),
            where('laborerId', '==', currentWorker.id),
            where('date', '==', today)
        );
        
        const taskSnapshot = await getDocs(taskQuery);
        
        if (!taskSnapshot.empty) {
            const task = taskSnapshot.docs[0].data();
            document.getElementById('task-description').textContent = task.task;
            document.getElementById('task-card').classList.remove('hidden');
        } else {
            document.getElementById('task-card').classList.add('hidden');
        }
    } catch (error) {
        console.error("Error loading task:", error);
    }
}

// Load sites
function loadSites() {
    const siteSelect = document.getElementById('site-select');
    const assignedSites = sitesData.filter(s => currentWorker.assignedSiteIds?.includes(s.id));
    
    if (assignedSites.length > 0) {
        siteSelect.innerHTML = assignedSites.map(s => 
            `<option value="${s.id}">${s.name}</option>`
        ).join('');
        siteSelect.disabled = false;
    } else {
        const t = translations[currentLanguage];
        siteSelect.innerHTML = `<option value="">${t.no_sites}</option>`;
        siteSelect.disabled = true;
        document.getElementById('start-work-btn').disabled = true;
        document.getElementById('start-work-btn').innerHTML = `
            <span class="text-3xl">ЁЯУН</span>
            <span>${t.contact_ajit}</span>
        `;
    }
}

// Show login
function showLogin() {
    currentWorker = null;
    workStartTime = null;
    stopTimer();
    document.getElementById('login-view').classList.remove('hidden');
    document.getElementById('dashboard-view').classList.add('hidden');
    document.getElementById('login-form').reset();
    document.getElementById('login-error').textContent = '';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    setLanguage(currentLanguage);
    
    // Language switchers
    document.querySelectorAll('#language-switcher .lang-btn, #language-switcher-dashboard .lang-btn-dash').forEach(btn => {
        btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
    });
    
    // Dark mode toggle
    document.getElementById('dark-mode-toggle').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const icon = document.querySelector('#dark-mode-toggle span');
        icon.textContent = document.body.classList.contains('dark-mode') ? 'тШАя╕П' : 'ЁЯМЩ';
    });
    
    // Login form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const t = translations[currentLanguage];
        const errorEl = document.getElementById('login-error');
        errorEl.textContent = '';
        
        const mobile = document.getElementById('mobile-number').value.trim();
        const pin = document.getElementById('pin').value.trim();
        
        if (mobile.length !== 10 || pin.length !== 4) {
            errorEl.textContent = t.invalid_login;
            return;
        }
        
        try {
            const q = query(
                collection(db, 'laborers'),
                where('mobileNumber', '==', mobile),
                where('pin', '==', pin)
            );
            
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                errorEl.textContent = t.invalid_login;
            } else {
                showDashboard({ id: snapshot.docs[0].id, ...snapshot.docs[0].data() });
            }
        } catch (error) {
            console.error("Login error:", error);
            errorEl.textContent = t.error_occurred;
        }
    });
    
    // Start work
    document.getElementById('start-work-btn').addEventListener('click', async () => {
        if (!currentWorker) return;
        
        const siteId = document.getElementById('site-select').value;
        if (!siteId) return;
        
        const t = translations[currentLanguage];
        
        try {
            workStartTime = new Date();
            
            await updateDoc(doc(db, 'laborers', currentWorker.id), {
                status: 'Work Started',
                currentSiteId: siteId
            });
            
            await createLog('Work Started', siteId);
            
            currentWorker.status = 'Work Started';
            currentWorker.currentSiteId = siteId;
            
            const site = sitesData.find(s => s.id === siteId);
            document.getElementById('current-site-name').querySelector('span:last-child').textContent = site.name;
            
            updateUI(true);
            startTimer();
            
            // Show brief success message
            const btn = document.getElementById('start-work-btn');
            btn.textContent = 'тЬЕ ' + t.work_started;
            setTimeout(() => btn.innerHTML = `<span class="text-3xl">ЁЯЯв</span><span>${t.start_work}</span>`, 2000);
            
        } catch (error) {
            console.error("Error starting work:", error);
            alert(t.error_start);
        }
    });
    
    // Upload photo button
    document.getElementById('upload-photo-btn').addEventListener('click', () => {
        document.getElementById('photo-upload-modal').classList.remove('hidden');
    });
    
    // Camera and gallery buttons
    document.getElementById('camera-btn').addEventListener('click', () => {
        const input = document.getElementById('photo-input');
        input.setAttribute('capture', 'environment');
        input.click();
    });
    
    document.getElementById('gallery-btn').addEventListener('click', () => {
        const input = document.getElementById('photo-input');
        input.removeAttribute('capture');
        input.click();
    });
    
    // Photo selection
    document.getElementById('photo-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Check file size (2MB limit)
        if (file.size > 2 * 1024 * 1024) {
            alert('File too large! Max 2MB allowed.');
            return;
        }
        
        selectedPhoto = file;
        
        // Show preview
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('photo-preview').src = e.target.result;
            document.getElementById('photo-preview-container').classList.remove('hidden');
            document.getElementById('upload-photo-submit-btn').disabled = false;
        };
        reader.readAsDataURL(file);
    });
    
    // Cancel photo upload
    document.getElementById('cancel-photo-btn').addEventListener('click', () => {
        document.getElementById('photo-upload-modal').classList.add('hidden');
        document.getElementById('photo-input').value = '';
        document.getElementById('photo-description').value = '';
        document.getElementById('photo-preview-container').classList.add('hidden');
        selectedPhoto = null;
        document.getElementById('upload-photo-submit-btn').disabled = true;
    });
    
    // Upload photo submit
    document.getElementById('upload-photo-submit-btn').addEventListener('click', async () => {
        if (!selectedPhoto || !currentWorker) return;
        
        const t = translations[currentLanguage];
        const description = document.getElementById('photo-description').value.trim();
        const statusEl = document.getElementById('upload-status');
        
        if (!description) {
            statusEl.textContent = 'Please add a description';
            statusEl.className = 'text-center text-sm font-semibold text-red-500';
            return;
        }
        
        // Check daily limit
        if (photosTodayCount >= 10) {
            alert('Daily photo limit reached (10 photos)');
            return;
        }
        
        try {
            statusEl.textContent = t.uploading;
            statusEl.className = 'text-center text-sm font-semibold text-blue-500';
            document.getElementById('upload-photo-submit-btn').disabled = true;
            
            // Compress image
            const compressedFile = await compressImage(selectedPhoto);
            
            // Upload to storage
            const timestamp = Date.now();
            const filename = `${currentWorker.id}_${timestamp}.jpg`;
            const storageRef = ref(storage, `work_photos/${currentWorker.currentSiteId}/${filename}`);
            
            await uploadBytes(storageRef, compressedFile);
            const photoURL = await getDownloadURL(storageRef);
            
            // Save metadata to Firestore
            await addDoc(collection(db, 'work_photos'), {
                laborerId: currentWorker.id,
                laborerName: currentWorker.name,
                siteId: currentWorker.currentSiteId,
                photoURL,
                description,
                uploadedAt: serverTimestamp()
            });
            
            photosTodayCount++;
            
            statusEl.textContent = t.photo_uploaded;
            statusEl.className = 'text-center text-sm font-semibold text-green-500';
            
            setTimeout(() => {
                document.getElementById('cancel-photo-btn').click();
                statusEl.textContent = '';
            }, 2000);
            
        } catch (error) {
            console.error("Error uploading photo:", error);
            statusEl.textContent = t.error_upload;
            statusEl.className = 'text-center text-sm font-semibold text-red-500';
            document.getElementById('upload-photo-submit-btn').disabled = false;
        }
    });
    
    // End work button
    document.getElementById('end-work-btn').addEventListener('click', () => {
        if (!currentWorker || !workStartTime) return;
        
        const now = new Date();
        const minutesWorked = (now - workStartTime) / (1000 * 60);
        const earnings = calculateEarnings(minutesWorked, currentWorker.hourlyRate || 0);
        const site = sitesData.find(s => s.id === currentWorker.currentSiteId);
        
        document.getElementById('end-work-site').querySelector('span').textContent = site?.name || 'Unknown';
        document.getElementById('end-work-hours').textContent = formatTime(minutesWorked);
        document.getElementById('end-work-earnings').textContent = `тВ╣${earnings}`;
        
        document.getElementById('end-work-modal').classList.remove('hidden');
    });
    
    // Cancel end work
    document.getElementById('cancel-end-work-btn').addEventListener('click', () => {
        document.getElementById('end-work-modal').classList.add('hidden');
    });
    
    // Confirm end work
    document.getElementById('confirm-end-work-btn').addEventListener('click', async () => {
        if (!currentWorker) return;
        
        const t = translations[currentLanguage];
        
        try {
            const now = new Date();
            const minutesWorked = (now - workStartTime) / (1000 * 60);
            const earnings = calculateEarnings(minutesWorked, currentWorker.hourlyRate || 0);
            const site = sitesData.find(s => s.id === currentWorker.currentSiteId);
            
            await updateDoc(doc(db, 'laborers', currentWorker.id), {
                status: 'Work Ended'
            });
            
            await createLog('Work Ended', currentWorker.currentSiteId);
            
            stopTimer();
            
            // Show success modal
            document.getElementById('end-work-modal').classList.add('hidden');
            document.getElementById('success-hours').textContent = formatTime(minutesWorked);
            document.getElementById('success-earnings').textContent = `тВ╣${earnings}*`;
            document.getElementById('success-site').textContent = site?.name || 'Unknown';
            
            // Random encouragement
            const randomMsg = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
            document.getElementById('encouragement-message').textContent = randomMsg;
            
            document.getElementById('work-ended-modal').classList.remove('hidden');
            
        } catch (error) {
            console.error("Error ending work:", error);
            alert(t.error_end);
        }
    });
    
    // Close success modal
    document.getElementById('close-success-btn').addEventListener('click', () => {
        document.getElementById('work-ended-modal').classList.add('hidden');
        currentWorker.status = 'Work Ended';
        workStartTime = null;
        updateUI(false);
        loadSites();
        load7DayHistory();
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', showLogin);
    
    // Initialize Firebase Auth
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const sitesSnapshot = await getDocs(collection(db, 'sites'));
                sitesData = sitesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (error) {
                console.error("Error loading sites:", error);
            }
        } else {
            signInAnonymously(auth).catch(err => console.error("Anonymous auth failed:", err));
        }
    });
    
    // Register service worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js');
    }
});